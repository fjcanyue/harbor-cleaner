# Harbor Cleaner (ä¸­æ–‡ç‰ˆ)

[English](./README.md)


![Go Version](https://img.shields.io/badge/Go-1.20%2B-blue.svg)
![License](https://img.shields.io/badge/License-MIT-green.svg)

ä¸€ä¸ªå…ˆè¿›çš„ã€æ”¯æŒå¤šç­–ç•¥çš„ Go è„šæœ¬ï¼Œç”¨äºæ™ºèƒ½æ¸…ç† Harbor é•œåƒä»“åº“ä¸­çš„æ—§é•œåƒã€‚è¯¥å·¥å…·æ”¯æŒç®€å•çš„åŸºäºæ—¶é—´çš„ä¿ç•™ç­–ç•¥ï¼Œä»¥åŠä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€ç”Ÿäº§ç¯å¢ƒå®‰å…¨çš„ Kubernetes æ„ŸçŸ¥å·¥ä½œæµã€‚

å®ƒä¸“ä¸ºåœ¨è‡ªåŠ¨åŒ–ç¯å¢ƒä¸­å®‰å…¨æ‰§è¡Œè€Œè®¾è®¡ï¼Œæä¾›è¯¦ç»†çš„æ—¥å¿—ã€å¯å®¡è®¡çš„æŠ¥å‘Šä»¥åŠè§£è€¦çš„ä¸¤é˜¶æ®µæµç¨‹ï¼Œä»¥å®ç°æœ€å¤§ç¨‹åº¦çš„æ§åˆ¶å’Œå®‰å…¨æ€§ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

-   **å¤šç­–ç•¥æ¸…ç†**ï¼š
    -   **`harbor`**ï¼šåŸºäºæ¨é€æ—¶é—´çš„ç®€å•ç­–ç•¥ï¼Œä¿ç•™æœ€æ–°çš„ N ä¸ªé•œåƒã€‚
    -   **`kubernetes`**ï¼šé«˜çº§ç­–ç•¥ï¼Œä»…æ¸…ç†å·²çŸ¥ç”±æ‚¨çš„ Kubernetes å·¥ä½œè´Ÿè½½ç®¡ç†çš„é•œåƒã€‚
-   **Kubernetes æ„ŸçŸ¥ä¿ç•™**ï¼šç›´æ¥ä»å¤šä¸ª Kubernetes é›†ç¾¤ã€éƒ¨ç½²ï¼ˆDeploymentsï¼‰å’Œæœ‰çŠ¶æ€é›†ï¼ˆStatefulSetsï¼‰ä¸­å‘ç°é•œåƒåŠå…¶å†å²è®°å½•ã€‚
-   **å®‰å…¨çš„ä¸¤é˜¶æ®µå·¥ä½œæµ**ï¼š`kubernetes` ç­–ç•¥åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š
    1.  **`scan`ï¼ˆæ‰«æï¼‰**ï¼šæ‰«æ K8s é›†ç¾¤å¹¶ç”Ÿæˆä¸€ä¸ªâ€œå®‰å…¨é•œåƒâ€æ¸…å•æ–‡ä»¶ä¾›å®¡æŸ¥ã€‚æ­¤é˜¶æ®µä¸æ‰§è¡Œä»»ä½•åˆ é™¤æ“ä½œã€‚
    2.  **`clean`ï¼ˆæ¸…ç†ï¼‰**ï¼šè¯»å–æ¸…å•æ–‡ä»¶å¹¶ç›¸åº”åœ°æ¸…ç† Harborã€‚æ­¤é˜¶æ®µä¸éœ€è¦ K8s è®¿é—®æƒé™ã€‚
-   **å…¨é¢çš„å®¡è®¡**ï¼š`clean` é˜¶æ®µä¼šç”Ÿæˆè¯¦ç»†çš„ CSV å®¡è®¡æŠ¥å‘Šï¼Œæ˜¾ç¤ºæ¯ä¸ªå¤„ç†è¿‡çš„é•œåƒåŠå…¶åœ¨ K8s ä¸­çš„ä½¿ç”¨æƒ…å†µçš„çŠ¶æ€ï¼ˆ`KEPT` - ä¿ç•™, `DELETED` - å·²åˆ é™¤, `TO BE DELETED` - å¾…åˆ é™¤ï¼‰ã€‚
-   **å®‰å…¨ç¬¬ä¸€**ï¼š
    -   `kubernetes` ç­–ç•¥**ä¸ä¼š**è§¦åŠä»»ä½•æœªè¢«æ‰«æçš„ K8s å·¥ä½œè´Ÿè½½ä½¿ç”¨çš„ Harbor ä»“åº“ã€‚
    -   é»˜è®¤å¯ç”¨ `dry-run`ï¼ˆæ¼”ç»ƒï¼‰æ¨¡å¼ï¼Œä»¥é˜²æ­¢æ„å¤–åˆ é™¤ã€‚
-   **é«˜åº¦å¯é…ç½®**ï¼šæ‰€æœ‰æ“ä½œéƒ½é€šè¿‡ä¸€ä¸ªä¸­å¿ƒçš„ `config.yaml` æ–‡ä»¶å’Œå‘½ä»¤è¡Œæ ‡å¿—è¿›è¡Œæ§åˆ¶ã€‚

## âš–ï¸ ç­–ç•¥è¯´æ˜

æ‚¨å¯ä»¥ä½¿ç”¨ `-strategy` æ ‡å¿—é€‰æ‹©ä¸€ç§ç­–ç•¥ã€‚

### 1. `harbor` ç­–ç•¥ (ç®€å•)
è¿™æ˜¯æœ€åˆå§‹ã€æœ€åŸºæœ¬çš„ç­–ç•¥ã€‚å®ƒä»…è¿æ¥åˆ° Harborï¼Œå¹¶æ ¹æ® `-keep.last` å’Œ `-keep.snapshots` è§„åˆ™ï¼Œä¸ºæ¯ä¸ªä»“åº“åˆ é™¤é™¤æœ€è¿‘æ¨é€çš„é•œåƒä¹‹å¤–çš„æ‰€æœ‰é•œåƒã€‚

**é€‚ç”¨åœºæ™¯**ï¼šå½“æ‚¨éœ€è¦ä¸€ä¸ªç®€å•çš„ã€åŸºäºæ—¶é—´çš„æ¸…ç†æ–¹æ¡ˆï¼Œå¹¶ä¸”ä¸éœ€è¦ä¸åƒ Kubernetes è¿™æ ·çš„ç³»ç»Ÿå…³è”æ—¶ã€‚

### 2. `kubernetes` ç­–ç•¥ (ç”Ÿäº§ç¯å¢ƒæ¨è)
è¿™æ˜¯æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒçš„é«˜çº§ç­–ç•¥ã€‚å®ƒå°†æ‚¨çš„ Kubernetes é›†ç¾¤è§†ä¸ºå“ªäº›é•œåƒæ˜¯é‡è¦çš„â€œäº‹å®æ¥æºâ€ã€‚å®ƒåˆ†ä¸¤ä¸ªä¸åŒé˜¶æ®µè¿è¡Œï¼Œä»¥å®ç°æœ€å¤§çš„å®‰å…¨æ€§å’Œå¯å®¡è®¡æ€§ã€‚

**é€‚ç”¨åœºæ™¯**ï¼šå½“æ‚¨å¸Œæœ›ç¡®ä¿å½“å‰æˆ–æœ€è¿‘è¢«æ‚¨çš„åº”ç”¨ç¨‹åºä½¿ç”¨çš„ä»»ä½•é•œåƒéƒ½ä¸ä¼šè¢«åˆ é™¤æ—¶ã€‚

## âš™ï¸ å…ˆå†³æ¡ä»¶

1.  **Go ç¯å¢ƒ**ï¼šGo 1.20 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚
2.  **Harbor è®¿é—®æƒé™**ï¼šæ‹¥æœ‰ Harbor å¸æˆ·çš„å‡­æ®ï¼ˆå¼ºçƒˆæ¨èä½¿ç”¨[æœºå™¨äººå¸æˆ·](https://goharbor.io/docs/2.10.0/user-guide/robot-accounts/)ï¼‰ï¼Œè¯¥å¸æˆ·éœ€è¦æœ‰åˆ—å‡ºé¡¹ç›®/ä»“åº“ä»¥åŠè¯»å–/åˆ é™¤åˆ¶å“çš„æƒé™ã€‚
3.  **Kubernetes è®¿é—®æƒé™ (ä»… `scan` é˜¶æ®µéœ€è¦)**ï¼šç”¨äºæ‚¨æ‰“ç®—æ‰«æçš„æ‰€æœ‰ Kubernetes é›†ç¾¤çš„æœ‰æ•ˆ `kubeconfig` æ–‡ä»¶ã€‚

## ğŸš€ å®‰è£…

1.  **å…‹éš†ä»“åº“**ï¼š
    ```bash
    git clone https://github.com/your-username/harbor-cleaner-go.git
    cd harbor-cleaner-go
    ```
2.  **å®‰è£…ä¾èµ–**ï¼š
    ```bash
    go mod tidy
    ```
3.  **æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶**ï¼š
    ```bash
    go build ./cmd/harbor-cleaner
    ```

## ğŸ“‹ é…ç½®æ–‡ä»¶ (`config.yaml`)

æ‰€æœ‰è„šæœ¬è¡Œä¸ºéƒ½ç”±ä¸€ä¸ªä¸­å¿ƒçš„ `config.yaml` æ–‡ä»¶æ§åˆ¶ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ `-c` æˆ– `--config` æ ‡å¿—æŒ‡å®šå…¶è·¯å¾„ã€‚

**`config.yaml` ç¤ºä¾‹**ï¼š 
```yaml
# é»˜è®¤ç­–ç•¥: "harbor" æˆ– "k8s"
strategy: "k8s"

# æ—¥å¿—çº§åˆ«: "debug", "info", "warn", "error"
log.level: "info"

# --- Harbor é…ç½® ---
harbor:
  url: "https://my.harbor.com"
  user: "robot$mycleaner"
  password: "your-robot-token"
  # æ¯ä¸ª Harbor API è¯·æ±‚è·å–çš„é¡¹ç›®æ•°
  page-size: 100
  # æ¯ä¸ªä»“åº“è¦ä¿ç•™çš„æœ€æ–°åˆ¶å“æ•°é‡ (harbor ç­–ç•¥)
  keep-last: 50
  # åœ¨æœ€æ–°çš„åˆ¶å“ä¸­ï¼Œæœ€å¤šä¿ç•™çš„ SNAPSHOT åˆ¶å“æ•°é‡ (harbor ç­–ç•¥)
  max-snapshots: 5
  # è¦æ‰«æçš„é¡¹ç›®åç§°çš„é€—å·åˆ†éš”åˆ—è¡¨ã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™æ‰«ææ‰€æœ‰é¡¹ç›®ã€‚
  project-whitelist: ""

# --- Kubernetes ç­–ç•¥é…ç½® ---
k8s:
  # kubernetes ç­–ç•¥çš„é˜¶æ®µ: "scan" æˆ– "clean"
  stage: "scan"
  # ç”¨äº "scan" å’Œ "clean" é˜¶æ®µçš„ä¸­é—´æ¸…å•æ–‡ä»¶
  manifest-file: "safe-images-manifest.csv"
  # ç”¨äº "clean" é˜¶æ®µçš„æœ€ç»ˆå®¡è®¡æŠ¥å‘Š CSV æ–‡ä»¶
  audit-file: ""

  # --- Kubernetes ç¯å¢ƒ ---
  environments:
    - name: "production"
      # kubeconfig æ–‡ä»¶è·¯å¾„
      kubeconfig: "/path/to/your/prod.kubeconfig"
      # è¦æ‰«æçš„å‘½åç©ºé—´
      namespaces:
        - "prod-ns-1"
        - "prod-ns-2"
      # å¯¹äºæ¯ä¸ªå·¥ä½œè´Ÿè½½ï¼Œä»å…¶å†å²è®°å½•ä¸­ä¿ç•™ N ä¸ªæœ€æ–°çš„å”¯ä¸€é•œåƒ
      keep: 5

    - name: "development"
      kubeconfig: "/path/to/your/dev.kubeconfig"
      namespaces:
        - "dev-ns"
      keep: 2

# --- é€šç”¨è®¾ç½® ---
# å¦‚æœä¸º trueï¼Œä»…æ‰“å°æ“ä½œã€‚å¯¹äº 'clean' é˜¶æ®µï¼Œè®¾ç½®ä¸º false ä»¥å®é™…åˆ é™¤ã€‚
dry-run: true
```

## ğŸ“– ç”¨æ³•ä¸å·¥ä½œæµ (Kubernetes ç­–ç•¥)

è¿™ä¸ªæ¨èçš„å·¥ä½œæµç¡®ä¿äº†å®‰å…¨æ€§ï¼Œå¹¶æä¾›äº†æ¸…æ™°çš„å®¡è®¡è¿½è¸ªã€‚

### é˜¶æ®µ 1: æ‰«æ Kubernetes å¹¶ç”Ÿæˆæ¸…å•

ä»¥ `scan` æ¨¡å¼è¿è¡Œè„šæœ¬ã€‚æ­¤é˜¶æ®µä¼šè¿æ¥åˆ°æ‚¨çš„ K8s é›†ç¾¤ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªå®ƒè®¤ä¸ºæ˜¯â€œå®‰å…¨â€çš„æ‰€æœ‰é•œåƒçš„ CSV æ¸…å•ã€‚**æ­¤é˜¶æ®µä¸éœ€è¦ Harbor å‡­æ®ã€‚**

ç¡®ä¿æ‚¨çš„ `config.yaml` æ–‡ä»¶ä¸­è®¾ç½®äº†æ­£ç¡®çš„ `k8s.stage: "scan"` å¹¶å®šä¹‰äº†æ‚¨çš„ Kubernetes ç¯å¢ƒã€‚

```bash
./harbor-cleaner -c config.yaml
```
-   å°†ä¼šåˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ `safe-images-manifest.csv`ã€‚

### é˜¶æ®µ 2: å®¡æŸ¥æ¸…å• (æ‰‹åŠ¨æ­¥éª¤)
æ‰“å¼€ `safe-images-manifest.csv`ã€‚è¿™æ˜¯æ‚¨å®¡æŸ¥è„šæœ¬è¯†åˆ«å‡ºçš„å®‰å…¨é•œåƒä»¥åŠåœ¨ä½•å¤„æ‰¾åˆ°å®ƒä»¬çš„æœºä¼šã€‚è¯¥æ–‡ä»¶å¯ä»¥è¿›è¡Œç‰ˆæœ¬æ§åˆ¶å¹¶ç”±æ‚¨çš„å›¢é˜Ÿå®¡æŸ¥ã€‚

**`safe-images-manifest.csv` ç¤ºä¾‹**ï¼š
```csv
image,environment,namespace
my.harbor.com/prod/app1:v1.2.3,production,prod-ns-1
my.harbor.com/prod/app1:v1.2.2,production,prod-ns-1
my.harbor.com/dev/app2:latest,development,dev-ns
```

### é˜¶æ®µ 3: ä½¿ç”¨æ¸…å•æ¸…ç† Harbor

ä¸€æ—¦æ‚¨æ‰¹å‡†äº†æ¸…å•ï¼Œå°±ä»¥ `clean` æ¨¡å¼è¿è¡Œè„šæœ¬ã€‚æ­¤é˜¶æ®µä¼šè¯»å–æ¸…å•æ–‡ä»¶å¹¶æ¸…ç† Harborã€‚**æ­¤é˜¶æ®µä¸éœ€è¦ K8s è®¿é—®æƒé™ã€‚**

æ›´æ–°æ‚¨çš„ `config.yaml` æ–‡ä»¶ï¼Œè®¾ç½® `k8s.stage: "clean"` å¹¶å¡«å†™æ‚¨çš„ Harbor å‡­æ®ã€‚

**é¦–å…ˆï¼Œå§‹ç»ˆåœ¨å¯ç”¨ `dry-run` çš„æƒ…å†µä¸‹è¿è¡Œï¼š**

åœ¨ `config.yaml` ä¸­è®¾ç½® `dry-run: true` å¹¶è¿è¡Œï¼š
```bash
./harbor-cleaner -c config.yaml
```
-   è¿™å°†ç”Ÿæˆä¸€ä»½æœ€ç»ˆçš„å®¡è®¡æŠ¥å‘Šï¼ˆä¾‹å¦‚ `cleanup-audit-20250805-015800.csv`ï¼‰ï¼Œæ˜¾ç¤ºå“ªäº›å†…å®¹*å°†ä¼š*è¢«åˆ é™¤ã€‚

**æœ€åï¼Œæ‰§è¡Œå®é™…çš„æ¸…ç†ï¼š**

åœ¨ `config.yaml` ä¸­è®¾ç½® `dry-run: false` å¹¶è¿è¡Œï¼š
```bash
./harbor-cleaner -c config.yaml
```
-   è¿™å°†æ‰§è¡Œåˆ é™¤æ“ä½œå¹¶åˆ›å»ºæœ€ç»ˆçš„å®¡è®¡æŠ¥å‘Šã€‚

### é˜¶æ®µ 4: è¿è¡Œ Harbor åƒåœ¾å›æ”¶ (GC)
> âš ï¸ **é‡è¦æç¤º**: æ­¤è„šæœ¬ä» Harbor æ•°æ®åº“ä¸­åˆ é™¤é•œåƒæ ‡ç­¾ã€‚è¦å›æ”¶ç£ç›˜ç©ºé—´ï¼Œæ‚¨**å¿…é¡»**åœ¨ Harbor UI ä¸­è¿è¡Œåƒåœ¾å›æ”¶ï¼ˆGCï¼‰ï¼ˆ`ç³»ç»Ÿç®¡ç†` -> `æ¸…ç†` -> `åƒåœ¾å›æ”¶`ï¼‰ã€‚

## ğŸ“„ å®¡è®¡æŠ¥å‘Šç¤ºä¾‹

`clean` é˜¶æ®µä¼šç”Ÿæˆä¸€ä»½è¯¦ç»†çš„ CSV æŠ¥å‘Šï¼Œä¸ºæ‚¨æä¾›æ“ä½œçš„å®Œæ•´è®°å½•ã€‚

**`cleanup-audit-20250805-015900.csv` ç¤ºä¾‹**ï¼š
```csv
Image,Status,Used In Environments,Used In Namespaces,Notes
my.harbor.com/prod/app1:v1.2.3,KEPT,production,prod-ns-1,In use by Kubernetes
my.harbor.com/prod/app1:v1.2.2,KEPT,production,prod-ns-1,In use by Kubernetes
my.harbor.com/prod/app1:v1.2.0,DELETED,-,-,Not found in K8s manifest file
my.harbor.com/dev/app2:latest,KEPT,development,dev-ns,In use by Kubernetes
my.harbor.com/dev/app2:old-feature,DELETED,-,-,Not found in K8s manifest file
```

## ğŸ›ï¸ é…ç½®ä¸æ ‡å¿—

è™½ç„¶å¤§å¤šæ•°è®¾ç½®éƒ½åœ¨ `config.yaml` ä¸­ç®¡ç†ï¼Œä½†æ‚¨å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œæ ‡å¿—è¦†ç›–é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚

| æ ‡å¿— | é»˜è®¤å€¼ | æè¿° |
| :--- | :--- | :--- |
| **`-c`, `--config`** | `config.yaml` | é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚ |

## ğŸ“ è®¸å¯è¯

è¯¥é¡¹ç›®æ ¹æ® [MIT è®¸å¯è¯](https://opensource.org/licenses/MIT) å‘å¸ƒã€‚